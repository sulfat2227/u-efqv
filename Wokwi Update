#include <Servo.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

Servo servo_15;
Servo servo_13;
LiquidCrystal_I2C lcd(0x27, 16, 2);

int ultrasonicsensor = 0;
unsigned long lastDetected = 0;
bool detected = false;

int messageIndex = 0;               // pesan aktif
unsigned long lastMessageChange = 0; 
String messages[] = {
  " SELAMAT DATANG |  DI SICANTIK ",
  "SAMPAH INOVATIF |  CEGAH JENTIK",
  "  HIJAU UNTUK   | SAMPAH ORGANIK",
  "  ORANYE UNTUK  |SAMPAH ANORGANIK",
  "  TERIMA KASIH  |                  "
};
int totalMessages = 5;

long readUltrasonicDistance(int triggerPin, int echoPin) {
  pinMode(triggerPin, OUTPUT);  
  digitalWrite(triggerPin, LOW);
  delayMicroseconds(2);
  digitalWrite(triggerPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(triggerPin, LOW);
  pinMode(echoPin, INPUT);
  return pulseIn(echoPin, HIGH);
}

void setup() {
  Serial.begin(9600);
  servo_15.attach(15, 500, 2500);
  servo_13.attach(A3, 500, 2500);
  pinMode(33, OUTPUT);
  pinMode(32, OUTPUT);
  pinMode(12, OUTPUT);
  pinMode(2, OUTPUT);
  lcd.init();
  lcd.display();
  lcd.backlight();   
}

void loop() {
  ultrasonicsensor = 0.01723 * readUltrasonicDistance(26, 25);
  Serial.println(ultrasonicsensor);

  unsigned long now = millis();

  if (ultrasonicsensor > 0 && ultrasonicsensor <= 200) {
    // === OBJEK TERDETEKSI ===
    servo_15.write(120);
    servo_13.write(60);
    digitalWrite(33, HIGH);
    digitalWrite(32, HIGH);
    digitalWrite(12, HIGH);
    digitalWrite(2, HIGH);
    lcd.display();
    lcd.backlight();
    detected = true;
    lastDetected = now;

    // ganti pesan tiap 2 detik
    if (now - lastMessageChange > 1500) {
      lcd.clear();
      lcd.setCursor(0,0);
      lcd.print(messages[messageIndex].substring(0,16));
      lcd.setCursor(0,1);
      lcd.print(messages[messageIndex].substring(17));
      messageIndex = (messageIndex + 1) % totalMessages;
      lastMessageChange = now;
    }

  } else {
    // === TIDAK TERDETEKSI ===
    if (detected) {
      servo_13.write(180);
      detected = false;
      servo_15.write(0); // servo langsung tutup
      detected = false;
    }

    unsigned long elapsed = now - lastDetected;

    if (elapsed >= 5500) { 
      lcd.clear();
      lcd.noDisplay();
      lcd.noBacklight();
    }

    if (elapsed >= 5000) {
      digitalWrite(33, LOW);
      digitalWrite(32, LOW);
      digitalWrite(12, LOW);
      digitalWrite(2, LOW);
      
    }
  }
}
